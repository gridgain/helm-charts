#
# Copyright (C) GridGain Systems. All Rights Reserved.
#  _________        _____ __________________        _____
#  __  ____/___________(_)______  /__  ____/______ ____(_)_______
#  _  / __  __  ___/__  / _  __  / _  / __  _  __ `/__  / __  __ \
#  / /_/ /  _  /    _  /  / /_/ /  / /_/ /  / /_/ / _  /  _  / / /
#  \____/   /_/     /_/   \_,__/   \____/   \__,_/  /_/   /_/ /_/
#

apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "gridgain9.fullname" . }}-init-job-{{ .Release.Revision }}
  namespace: {{ .Release.Namespace | quote }}
  labels: {{- include "gridgain9.labels" . | nindent 4 }}
  {{- if or .Values.commonAnnotations .Values.annotations }}
  annotations:
  {{- $annotations := include "common.tplvalues.merge" ( dict "values" ( list .Values.annotations .Values.commonAnnotations ) "context" . ) }}
  {{- toYaml $annotations | nindent 4 }}
  {{- end }}
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      {{- if .Values.podAnnotations }}
      annotations:
        {{- toYaml .Values.podAnnotations | nindent 8 }}
      {{- end }}
    spec:
      {{- if .Values.affinity }}
      affinity: {{- toYaml .Values.affinity | nindent 8 }}
      {{- end }}
      {{- if .Values.nodeSelector }}
      nodeSelector: {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.tolerations }}
      tolerations: {{- toYaml .Values.tolerations | nindent 8 }}
      {{- end }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets: {{- toYaml .Values.imagePullSecrets | nindent 6 }}
      {{- end }}
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "gridgain9.serviceAccountName" . }}
      {{- end }}
      containers:
      # Command to init the cluster. URL and host must be the name of the service you created before. Port is 10300 as the management port.
      - args:
        - -ec
        - |
          set -x

          # Get the number of replicas from the StatefulSet or use default
          REPLICAS=${REPLICAS:-1}

          # Wait for GridGain service to be available and all nodes to be ready
          echo "Waiting for GridGain service to be available..."
          SERVICE_HOST="{{ include "gridgain9.fullname" . }}-headless"
          SERVICE_PORT="{{ .Values.services.headless.ports.management }}"

          # Wait for service to be available
          retries=60 # 5 minutes
          while ! timeout 5 bash -c "</dev/tcp/${SERVICE_HOST}/${SERVICE_PORT}" 2>/dev/null; do
            echo "Waiting for GridGain service to be available... (retries left: $retries)"
            retries=$((retries-1))
            if [ "$retries" -eq 0 ]; then
              echo "ERROR: GridGain service did not become available within 5 minutes"
              exit 1
            fi
            sleep 5
          done
          echo "GridGain service is available"

          # Check if cluster is already initialized to ensure idempotency
          echo "Checking if cluster is already initialized..."
          CLUSTER_STATUS=$(/opt/gridgain9cli/bin/gridgain9 cluster status --url=http://${SERVICE_HOST}:${SERVICE_PORT} 2>&1 || true)
          if echo "$CLUSTER_STATUS" | grep -qi "active"; then
            echo "Cluster is already initialized and active, skipping init"
            exit 0
          fi
          echo "Cluster is not yet initialized, proceeding..."

          # Wait for last node to be ready using GridGain CLI
          echo "Waiting for last node to be ready..."
          retries=60 # 5 minutes
          while [ $retries -gt 0 ]; do
            # Try to get cluster topology using GridGain CLI
            if /opt/gridgain9cli/bin/gridgain9 cluster topology physical --url=http://${SERVICE_HOST}:${SERVICE_PORT} 2>/dev/null | grep -q "{{ include "gridgain9.fullname" . }}-$((REPLICAS-1))"; then
              echo "All nodes are ready in cluster topology"
              break
            fi
            echo "Waiting for last node to be ready... (retries left: $retries)"
            retries=$((retries-1))
            if [ "$retries" -eq 0 ]; then
              echo "ERROR: Not all nodes appeared in cluster topology within 5 minutes"
              exit 1
            fi
            sleep 5
          done

          # Log the approach being used
          echo "Using StatefulSet naming pattern for cluster initialization"
          echo "Replica count: $REPLICAS"

          /opt/gridgain9cli/bin/gridgain9 cluster init --name={{ include "gridgain9.fullname" . }} --url=http://{{ include "gridgain9.fullname" . }}-headless:{{ .Values.services.headless.ports.management }} --license={{ .Values.license.mountPath }} --config-files={{ .Values.clusterConfig.mountPath }}
        command:
        - /bin/bash
        # Specify the Docker image with the GridGain 9 CLI and its version.
        image: {{ .Values.image.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}
        imagePullPolicy: IfNotPresent
        name: cluster-init
        resources:
          {{- toYaml .Values.hookResources | nindent 10 }}
        env:
        - name: REPLICAS
          value: "{{ .Values.replicaCount | default 1 }}"
        volumeMounts:
        {{- if .Values.license.useExisting }}
        - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "license" }}
          mountPath: {{ .Values.license.mountPath }}
          subPath: {{ .Values.license.useExisting.secretkey }}
          readOnly: true
        {{- else if or .Values.license.createSecret .Values.license.fromFile  }}
        - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "license" }}
          mountPath: {{ .Values.license.mountPath }}
          subPath: license.conf
          readOnly: true
        {{- end }}
        {{- if .Values.clusterConfig.useExisting }}
        - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "cluster-config" }}
          mountPath: {{ .Values.clusterConfig.mountPath }}
          subPath: {{ .Values.clusterConfig.useExisting.secretkey }}
          readOnly: true
        {{- else if or .Values.clusterConfig.createSecret .Values.clusterConfig.fromFile  }}
        - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "cluster-config" }}
          mountPath: {{ .Values.clusterConfig.mountPath }}
          subPath: cluster.json
          readOnly: true
        {{- end }}
      restartPolicy: Never
      terminationGracePeriodSeconds: 120
      volumes:
      {{- if .Values.license.useExisting }}
      - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "license" }}
        secret:
          secretName: {{ .Values.license.useExisting.secretname }}
      {{- else if or .Values.license.createSecret .Values.license.fromFile }}
      - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "license" }}
        secret:
          secretName: {{ printf "%s-%s" (include "gridgain9.fullname" .) "license" }}
      {{- end }}
      {{- if .Values.clusterConfig.useExisting }}
      - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "cluster-config" }}
        secret:
          secretName: {{ .Values.clusterConfig.useExisting.secretname }}
      {{- else if or .Values.clusterConfig.createSecret .Values.clusterConfig.fromFile }}
      - name: {{ printf "%s-%s" (include "gridgain9.fullname" .) "cluster-config" }}
        secret:
          secretName: {{ printf "%s-%s" (include "gridgain9.fullname" .) "cluster-config" }}
      {{- end }}
